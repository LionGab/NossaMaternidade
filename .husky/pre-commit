#!/bin/bash

echo "Running pre-commit checks..."

# Use bun if available, otherwise fallback to npm
if command -v bun > /dev/null 2>&1; then
  PKG_RUNNER="bun"
else
  PKG_RUNNER="npm"
fi

# 1. TypeScript
echo "[1/4] TypeScript check..."
$PKG_RUNNER run typecheck || exit 1

# 2. ESLint
echo "[2/4] ESLint..."
$PKG_RUNNER run lint || exit 1

# 3. Design validation (if hook exists)
if [ -f ".claude/hooks/pre-commit-design.sh" ]; then
  echo "[3/4] Design validation..."
  bash .claude/hooks/pre-commit-design.sh || exit 1
else
  echo "[3/4] Design validation... (skipped - hook not found)"
fi

# 4. Security check - no exposed API keys
echo "[4/4] Security check..."
EXPOSED_KEYS=$(grep -rn "sk-[a-zA-Z0-9]\{20,\}" src/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "// sk-" | wc -l | tr -d ' ')
if [ "$EXPOSED_KEYS" -gt "0" ]; then
  echo "ERROR: Possible API key exposure detected!"
  grep -rn "sk-[a-zA-Z0-9]\{20,\}" src/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "// sk-" | head -3
  exit 1
fi

echo "All pre-commit checks passed!"
